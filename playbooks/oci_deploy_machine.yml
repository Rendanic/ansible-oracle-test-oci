---

- name: Deploy machines
  hosts: "{{ hostgroup | mandatory }}"
  gather_facts: false
  any_errors_fatal: true
  vars:
    instance_ad: DCSu:EU-FRANKFURT-1-AD-1
    instance_compartment: ocid1.compartment.oc1..aaaaaaaaye3pks3l3v5sdl265sj5yuag2pmx4r6pvkzkv7voclmtdcbjzozq
    instance_subnet_id: ocid1.subnet.oc1.eu-frankfurt-1.aaaaaaaag2wmn7xfyw23tin5x43oovqevwf6updw5ddm3ogmzmvaihksmiqq
    instance_image: ocid1.image.oc1.eu-frankfurt-1.aaaaaaaa4qgh74csl6sentnhk4wq32cjeqsqpejwyyfvg2ikr44w7gbmomwa
    instance_shape:  "VM.Standard.E4.Flex"
    instance_hostname: ansible-oracle-test

  tasks:
    - name: Launch instance
      oracle.oci.oci_compute_instance:
        availability_domain: "{{ instance_ad }}"
        compartment_id: "{{ instance_compartment }}"
        name: "{{ instance_hostname }}"
        source_details:
          source_type: image
          image_id: "{{ instance_image }}"
        shape: "{{ instance_shape }}"
        create_vnic_details:
            assign_public_ip: True
            hostname_label: "{{ instance_hostname }}"
            subnet_id: "{{ instance_subnet_id }}"
        # metadata:
        #     ssh_authorized_keys: "{{ lookup('file',  my_test_public_key ) }}"
      register: result

    - name: Print instance details
      debug:
        msg: "Launched a new instance {{ result }}"
    - set_fact:
        instance_id: "{{result.instance.id }}"
